\documentclass{article}
\usepackage[utf8]{inputenc}
% \usepackage{l3backend}
% \usepackage{fontspec}
\usepackage[usenames,svgnames]{xcolor}
% \usepackage{xunicode}

% Page setup
\usepackage[a4paper,landscape,margin=2cm]{geometry}
\usepackage{amsmath}
% \newfontfamily\ubuntumono{Ubuntu Mono}
% Typography
\usepackage[scaled]{helvet}
\let\familydefault\sfdefault


\usepackage{tikz,pgfplots,tikz-layers,tikzpeople}
\usetikzlibrary{positioning,arrows,intersections,calc,fit,backgrounds,shapes,matrix}

\definecolor{colorwhite}    {RGB}{255,255,255}
\definecolor{colorpod}      {RGB}{199,212,104}
\definecolor{colorbook}     {RGB}{ 79,142,209} 
\definecolor{colorprofile}  {RGB}{143,232,186}
\definecolor{colortext}     {RGB}{ 29, 29, 27}
\definecolor{colorkey}      {RGB}{129, 29, 27}
\definecolor{colorperson}   {RGB}{190, 22, 34}

\makeatletter
\pgfdeclareshape{datastore}{
  \inheritsavedanchors[from=rectangle]
  \inheritanchorborder[from=rectangle]
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{base}
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{south east}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{south west}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{north west}
  \backgroundpath{
    %  store lower right in xa/ya and upper right in xb/yb
    \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
    \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
    \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
    \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@yb}}
    \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
 }
}
\makeatother

\begin{document}
\pagestyle{empty}

% ======================================= V

\begin{tikzpicture}[
    node distance = 10em, auto, thick,
    title/.style={text=colortext,font={\Large\itshape}},
    person/.style={text=colorwhite,font={\Large\bfseries}},
    code/.style={text=colortext,font={}},
    key/.style={text=colorkey,font={\tiny\itshape}},
    every matrix/.style={ampersand replacement=\&,column sep=2cm,row sep=2cm ,
    nodes in empty cells},
    matrixstyle/.style={
      matrix of nodes,
      nodes in empty cells,
      column sep      = -\pgflinewidth,
      row sep         = -\pgflinewidth,
      nodes={%
        inner sep=0mm,outer sep=0pt,
        minimum size=5mm,
        text height=\ht\strutbox,text depth=\dp\strutbox,
        draw
      }},
    source/.style={draw,thick,rounded corners,fill=yellow!20,inner sep=.3cm},
    db/.style={draw,thick,fill=yellow!20},
    process/.style={draw,thick,circle,fill=blue!20},
    sink/.style={source,fill=green!20,inner sep=.5cm, minimum height=2cm},
    pod/.style={draw,thick,rectangle,fill=colorpod,inner sep=.5cm, minimum height=2cm},
    datastore/.style={draw,very thick,shape=datastore,inner sep=.3cm},
    dots/.style={gray,scale=2},
    to/.style={->,>=stealth',shorten >=1pt,semithick,font=\sffamily\footnotesize},
    every node/.style={align=center}]
  
    % % Position the nodes using a matrix layout
    % \& \node[datastore] (buffer) {buffer};  \& \\

    % \node[datastore] (storage) {storage};     \& \node[process] (monitor) {monitor};  \& \node[sink] (datastore) {datastore}; \\
   \node[alice,minimum size=2em,label={[label distance=0.1em]below:Alice}] (ALICE){};
  %  \node[person,process,fill=colorperson] (ALICE) {Alice};
   \node[sink, right=of ALICE] (FE) {Query \\ Engine}; 
   \node[sink, right = of FE] (IAM) [align=left] {Aggregator}; 
   \node[pod, below = of FE] (POD2) {Pods};
   \node[pod, left = of POD2] (POD1) {Pods}; 
  \node[pod, right = of POD2] (POD3) {Pods};
  \node[title,font=\sffamily\footnotesize, below=1em of POD1] (KPOD1) {$K_1^{Bob}\dots K_n^{Bob}$};
  \node[title,font=\sffamily\footnotesize, below=1em of POD2] (KPOD2) {$K_1^{Carol}\dots K_n^{Carol}$};
  \node[title, below=1em of POD3] (KPOD2) {};
  
    % \matrix (TOP)  {
    %  \& \node[person,process,fill=colorperson] (ALICE) {Alice}; \& \node[sink] (FE) {Federation \\ Engine}; \& \node[sink] (IAM) {\*Init\\Aggregate\\\* Maintenance}; \\
    % };
    % \matrix [below of=TOP]{
    %   \node[pod] (POD1) {Pods}; \& \node[pod] (POD2) {Pods}; \& \node[pod] (POD3) {Pods};\\
    % };
    % \node[draw,fill=orange!30] at ([yshift=0.75cm]ACP.south){SHACL Shape};
    % Draw the arrows between the nodes and label them.
    \draw[to] (ALICE) -- node[midway,above] {$q,K$} node[midway,below] {Query, Keys} (FE);
    \draw[to] (IAM) -- node[midway,above] {Request Summaries} (FE);
    \draw[to] (FE) -- node[midway,below] {Summaries $\Sigma$ } (IAM); 
    \draw[-,>=stealth',shorten >=1pt,semithick,font=\sffamily\footnotesize] (POD1.north) -- node[midway,sloped] {$q, K{\& \atop |}Cred$} (FE);
    \draw[-,>=stealth',shorten >=1pt,semithick,font=\sffamily\footnotesize] (POD2.north) -- node[midway,sloped] {$q, K{\& \atop |}Cred$} (FE);
    \draw[-,>=stealth',shorten >=1pt,semithick,font=\sffamily\footnotesize] (POD3.north) -- node[midway,sloped] {\phantom{$q, K{\& \atop |}Cred$}} (FE);
    \draw[-,>=stealth',shorten >=1pt,semithick,dashed,font=\sffamily\footnotesize] (POD1.north) -- node[midway,sloped] {} (IAM);
    \draw[-,>=stealth',shorten >=1pt,semithick,dashed,font=\sffamily\footnotesize] (POD2.north) -- node[midway,sloped] {} (IAM);
    \draw[-,>=stealth',shorten >=1pt,semithick,dashed,font=\sffamily\footnotesize] (POD3.north) -- node[midway,sloped] {} (IAM);

    \begin{scope}[on above layer]
      \node[fill=blue!20, draw, semithick,below left=0.5em and -1em of POD1.west, rectangle,minimum width=2em,minimum height=1em] (blue1) {};
      \node[fill=green!20, draw, semithick,rectangle,below= 0.5em of blue1, minimum width=2em, minimum height=1em] (green1) {};
      \node[fill=blue!20, draw, semithick,below left=0.5em and -1em of POD2.west, rectangle,minimum width=2em,minimum height=1em] (blue2) {};
      \node[fill=green!20, draw, semithick,rectangle,below= 0.5em of blue2, minimum width=2em, minimum height=1em] (green2) {};
      \node[fill=blue!20, draw, semithick,below left=0.5em and -1em of POD3.west, rectangle,minimum width=2em,minimum height=1em] (blue3) {};
      \node[fill=green!20, draw, semithick,rectangle,below= 0.5em of blue3, minimum width=2em, minimum height=1em] (green3) {};
      \end{scope}
    % \draw[to] (ACP) -- node[midway,above] {Query} (DS);
    % \draw[to] (DS) to[bend left=25] node[midway,below] {Results} (ALICE);

    % \draw[to] (AW) -- node[midway,right] {raw event data\\level 1} (buffer);
    % \draw[to] (buffer) --
    %     node[midway,right] {raw event data\\level 1} (monitor);
    % \draw[to] (monitor) to[bend left=50] node[midway,above] {events}
    %     node[midway,below] {level 1} (storage);
    % \draw[to] (storage) to[bend right=50] node[midway,above] {events}
    %     node[midway,below] {level 1} (monitor);
    % \draw[to] (monitor) -- node[midway,above] {events}
    %     node[midway,below] {level 1} (datastore);

    % % Person Alice
    % \draw[fill=colorperson] (2,4) circle (30pt);
    % \node[person] at (2,4) (alice) {Alice};
    
    % % % Person Dave
    % % \draw[fill=colorperson] (17,4) circle (30pt);
    % % \node[person] at (17,4) (dave) {Dave};

    % % % Pod Alice
    % % \draw[fill=colorpod] (5.5,0) rectangle (13.5,5.5);
    % % \node[title,text width=10em] at (7.5,5) {Authentication WebID};

    % % Address Book Alice
    % \draw[fill=colorbook] (6,0.5) rectangle (13,4);
    % \node[title,text width=10em] at (8,3.5) {Authentication};
    % \node[code,text width=10em] at (13,3.5) {WebID};
    % \node[code,text width=20em] at (9.8,2) {$<$/profile\#me$>$ :knows\\
    % \ \ $<$https://bob.pods.org/profile\#me$>$,\\
    % \ \ $<$https://carol.org/\#i$>$,\\
    % \ldots};
    
    % % Pod Bob
    % \draw[fill=colorpod] (0,-6.5) rectangle (8,-1.5);
    % \node[title,text width=10em] at (2,-2) {Pod Bob};
    % \node[code,text width=10em] at (6,-2) {https://bob.pods.org/};
    
    % % Profile Bob
    % \draw[fill=colorprofile] (0.5,-6) rectangle (7.5,-3);
    % \node[title,text width=10em] at (2.5,-3.5) {Profile};
    % \node[code,text width=10em] at (7.5,-3.5) {/profile};
    % \node[code,text width=20em] at (4.3,-5) {$<$/profile\#me$>$ :name "Bob".\\
    % $<$/profile\#me$>$ :email $<$bob@mail.org$>$.\\
    % $<$/profile\#me$>$ :telephone "0499 12 222a".};
    % \node[key] at (0.75,-4.55) {R1$_B$};
    % \node[key] at (0.75,-4.98) {R1$_B$};
    % \node[key] at (0.75,-5.42) {R3$_B$};
    % \node[key] at (4,-6.25) {Alice $\in$ R1$_B$, R2$_B$, R3$_B$; Dave $\in$ R1$_B$};
    
    % % Pod Carol
    % \draw[fill=colorpod] (11,-6.5) rectangle (19,-1.5);
    % \node[title,text width=10em] at (13,-2) {Pod Carol};
    % \node[code,text width=10em] at (17.7,-2) {https://carol.org/};
    
    % % Profile Carol
    % \draw[fill=colorprofile] (11.5,-6) rectangle (18.5,-3);
    % \node[title,text width=10em] at (13.5,-3.5) {Profile};
    % \node[code,text width=10em] at (19,-3.5) {/};
    % \node[code,text width=20em] at (15.3,-5) {$<$/\#i$>$ :name "Carol".\\
    % $<$/\#i$>$ :email $<$i@carol.org$>$.\\
    % $<$/\#i$>$ :telephone "0499 11 22 33".};
    % \node[key] at (11.75,-4.55) {R1$_C$};
    % \node[key] at (11.75,-4.98) {R2$_C$};
    % \node[key] at (11.75,-5.42) {R3$_C$};
    % \node[key] at (15,-6.25) {Alice $\in$ R1$_C$, R2$_C$; Dave $\in$ R1$_C$};

    % % Arrows between pods
    % \draw[->,thick,dashed](6.6,2.2) to [out=180,in=90] (4,-3);
    % \draw[->,thick,dashed](10,1.75) to [out=0,in=90] (15,-3);
    
    % % Arrows from people to data
    % \draw[->,thick,colorperson] (alice) -- (6,3.5);
    % \draw[->,thick,colorperson] (alice) -- (3.5,-3);
    % \draw[->,thick,colorperson] (alice) -- (11.5,-3);
    % \draw[->,thick,colorperson] (dave)  -- (13,3.5);
    % \draw[->,thick,colorperson] (dave)  -- (7.5,-3);
    % \draw[->,thick,colorperson] (dave)  -- (15.5,-3);

\end{tikzpicture}
\end{document}
